import{u as de,r as u,j as e,b as ye}from"./index-gi7GTMaL.js";function xe({cart:r,fromAddress:_,toAddress:V,onRates:k,onResponse:P,onSelect:I,compact:le,showResults:ne,inlineResults:i=!0,onCalculateClick:J}){const{dispatch:O}=de(),[Z,C]=u.useState(!1),[$,W]=u.useState(null),[q,U]=u.useState(null),[X,E]=u.useState(null),[Q,G]=u.useState(null),M=()=>{let m=0;for(const o of r.items){const b=o.product.weight||1;m+=b*16*o.quantity}return m},y=async()=>{var m,o,b;C(!0),E(null),W(null);try{const s=(m=r.items[0])==null?void 0:m.product,N=p=>p?p/25.4:void 0,x={length:N(s==null?void 0:s.length_mm)||10,width:N(s==null?void 0:s.width_mm)||8,height:N(s==null?void 0:s.height_mm)||4,distance_unit:"in",weight:M(),mass_unit:"oz"},f=V||r.shippingAddress||{name:"Customer",street1:"1438 8th St",city:"Santa Monica",state:"CA",zip:"90405",country:"US"};if(!(f&&f.street1&&f.city&&f.state&&f.zip&&/^[A-Za-z]{2}$/.test(String(f.state))&&/^[0-9]{5}(-[0-9]{4})?$/.test(String(f.zip)))){E("Please enter a complete shipping address before calculating rates"),C(!1);return}console.debug("Shipping to:",f),console.debug("Parcel:",x);const ee=(()=>{try{let p=Number(x.weight)||0;const g=(x.mass_unit||"").toString().toLowerCase();return g==="oz"||g==="ounces"?p=p/16:g==="kg"||g==="kilograms"?p=p*2.2046226218:(g==="g"||g==="grams")&&(p=p/453.59237),p}catch{return 0}})(),ie=(()=>{try{const p=Number(x.length||0),g=Number(x.width||0),v=Number(x.height||0),c=2*(g+v);return p+c>165}catch{return!1}})(),w=await(await fetch("/.netlify/functions/get-shipping-rates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to_address:f,from_address:_,parcel:x})})).json();if(w.estes_quote?U(w.estes_quote):U(null),w.rates){const p=Array.isArray(w.rates)?w.rates.slice():[],g=!!w.estes_quote,v=p.filter(j=>{try{const F=j&&j.object_id||j&&j.raw&&j.raw.id||"";if(!g&&F&&String(F).startsWith("freight-placeholder"))return!1}catch{}return!0});p.sort((j,F)=>Number(j.amount||0)-Number(F.amount||0));const c=v&&v.length>0?v:[],h=c[0];if(W(c),h){G(h.object_id);try{O({type:"SET_SHIPPING_COST",shipping:{cost:Number(h.amount),label:`${h.provider} ${((o=h.servicelevel)==null?void 0:o.name)||((b=h.servicelevel)==null?void 0:b.token)||""}`,rateId:h.object_id},cost:Number(h.amount),rate:h})}catch(j){console.error("Failed to dispatch shipping selection",j)}if(typeof I=="function")try{I(h)}catch(j){console.warn("onSelect handler failed",j)}}typeof P=="function"&&P({rates:c,selected:h}),typeof k=="function"&&k(c),(!v||v.length===0)&&p.length>0&&!g&&E("Unable to obtain carrier rates for this shipment")}else E(w.error||"No rates found");if(!w.rates&&w.estes_quote){const p=Object.values(w.estes_quote).filter(g=>Array.isArray(g)&&g.length>0);if(p.length>0){const v=p[0].map((c,h)=>{const j=Number(c.amount||c.price||c.rate||c.total&&c.total.amount||0);return{amount:j?String(j):"0.00",object_id:c.id||c.quoteId||`estes-${h}`,provider:"Estes",servicelevel:{name:c.service||c.serviceLevel||c.name||"Estes Freight",token:c.service||null},estimated_days:c.transit_days||c.delivery_days||null,currency:c.currency||"USD",raw:c}});W(v),typeof k=="function"&&k(v)}}}catch(s){E(s.message)}finally{C(!1)}};return e.jsxs("div",{style:{margin:"1.5rem 0"},children:[e.jsx("button",{className:"btn secondary",style:{fontWeight:600,fontSize:"1rem",borderRadius:8,padding:"0.7rem 2rem"},onClick:()=>{try{typeof J=="function"&&J()}catch{}y()},disabled:Z,children:Z?"Getting Shipping Rates...":"Calculate Shipping"}),X&&e.jsx("div",{style:{color:"#d32f2f",marginTop:8},children:X}),i&&$&&$.length>0&&e.jsxs("div",{style:{marginTop:12},children:[e.jsx("b",{children:"Shipping Rates:"}),e.jsx("ul",{style:{margin:0,padding:0,listStyle:"none"},children:(Array.isArray($)?$.slice().sort((o,b)=>Number(o.amount||0)-Number(b.amount||0)):[]).map(o=>{var b,s;return e.jsxs("li",{style:{margin:"6px 0",display:"flex",alignItems:"center",gap:8},children:[e.jsx("input",{type:"radio",name:"shippingRate",value:o.object_id,checked:Q===o.object_id,onChange:()=>{var N,x;G(o.object_id);try{O({type:"SET_SHIPPING_COST",shipping:{cost:Number(o.amount),label:`${o.provider} ${((N=o.servicelevel)==null?void 0:N.name)||((x=o.servicelevel)==null?void 0:x.token)||""}`,rateId:o.object_id},cost:Number(o.amount),rate:o})}catch(f){console.error(f)}if(typeof I=="function")try{I(o)}catch(f){console.warn("onSelect handler failed",f)}}}),e.jsxs("div",{style:{flex:1},children:[e.jsxs("div",{style:{fontWeight:700},children:[o.provider," ",((b=o.servicelevel)==null?void 0:b.name)||((s=o.servicelevel)==null?void 0:s.token)]}),e.jsxs("div",{style:{color:"#555"},children:[o.estimated_days||"?"," days"]})]}),e.jsxs("div",{style:{minWidth:90,textAlign:"right",fontWeight:700},children:["$",o.amount]})]},o.object_id)})})]}),i&&q&&e.jsxs("div",{style:{marginTop:12,paddingTop:12,borderTop:"1px dashed #eee"},children:[e.jsx("b",{children:"Estes Freight Options:"}),(()=>{const m=Object.values(q).filter(s=>Array.isArray(s)&&s.length>0);if(m.length===0)return e.jsx("pre",{style:{whiteSpace:"pre-wrap",fontSize:"0.85rem",color:"#333"},children:JSON.stringify(q,null,2)});const b=m[0].map((s,N)=>{const x=Number(s.amount||s.price||s.rate||s.total&&s.total.amount||0);return{amount:x?String(x):"0.00",object_id:s.id||s.quoteId||`estes-${N}`,provider:"Estes",servicelevel:{name:s.service||s.serviceLevel||s.name||"Estes Freight"},estimated_days:s.transit_days||s.delivery_days||null,raw:s}});return e.jsx("ul",{style:{margin:0,padding:0,listStyle:"none"},children:b.map(s=>{var N;return e.jsxs("li",{style:{margin:"6px 0",display:"flex",alignItems:"center",gap:8},children:[e.jsx("input",{type:"radio",name:"shippingRate",value:s.object_id,checked:Q===s.object_id,onChange:()=>{G(s.object_id);try{O({type:"SET_SHIPPING_COST",shipping:{cost:Number(s.amount),label:`Estes ${s.servicelevel.name}`,rateId:s.object_id},cost:Number(s.amount),rate:s})}catch(x){console.error(x)}if(typeof I=="function")try{I(s)}catch(x){console.warn("onSelect handler failed",x)}}}),e.jsxs("div",{style:{flex:1},children:[e.jsxs("div",{style:{fontWeight:700},children:[s.provider," ",(N=s.servicelevel)==null?void 0:N.name]}),e.jsxs("div",{style:{color:"#555"},children:[s.estimated_days||"?"," days"]})]}),e.jsxs("div",{style:{minWidth:90,textAlign:"right",fontWeight:700},children:["$",s.amount]})]},s.object_id)})})})()]})]})}const fe={AL:.04,AK:0,AZ:.056,AR:.065,CA:.0825,CO:.029,CT:.0635,DE:0,FL:.06,GA:.04,HI:.04,ID:.06,IL:.0625,IN:.07,IA:.06,KS:.065,KY:.06,LA:.0445,ME:.055,MD:.06,MA:.0625,MI:.06,MN:.06875,MS:.07,MO:.04225,MT:0,NE:.055,NV:.0685,NH:0,NJ:.06625,NM:.05125,NY:.04,NC:.0475,ND:.05,OH:.0575,OK:.045,OR:0,PA:.06,RI:.07,SC:.06,SD:.045,TN:.07,TX:.0625,UT:.0485,VT:.06,VA:.053,WA:.065,WV:.06,WI:.05,WY:.04};function ce(r){if(!r)return 0;const _=String(r).trim().toUpperCase();return Number(fe[_]||0)}function re({title:r,open:_,onToggle:V,children:k,disabled:P}){return e.jsxs("section",{style:{borderRadius:12,border:"1px solid #e6e6e6",marginBottom:12,overflow:"hidden",background:"#f0f0f0"},children:[e.jsxs("button",{onClick:()=>!P&&V(!_),style:{width:"100%",textAlign:"left",padding:"14px 16px",background:"#333",color:"#fafafa",border:"none",cursor:P?"not-allowed":"pointer",fontSize:"1.05rem"},"aria-expanded":_,"aria-disabled":P,children:[e.jsx("strong",{style:{fontSize:"1.05rem"},children:r}),e.jsx("span",{style:{float:"right"},children:_?"▾":"▸"})]}),_&&e.jsx("div",{style:{padding:24},children:k})]})}function je(){u.useEffect(()=>{try{return document.body.classList.add("checkout-page"),()=>document.body.classList.remove("checkout-page")}catch{}},[]);const{cart:r,dispatch:_}=de();ye();const[V,k]=u.useState(!0),[P,I]=u.useState(!1),[le,ne]=u.useState(!1),[i,J]=u.useState({name:"",street1:"",city:"",state:"",zip:"",country:"US",phone:""}),[O,Z]=u.useState([]),[C,$]=u.useState({name:"",street1:"",city:"",state:"",zip:"",country:"US",phone:""}),[W,q]=u.useState(""),[U,X]=u.useState("stripe"),[E,Q]=u.useState(!1),[G,M]=u.useState(!1),[y,m]=u.useState(null),[o,b]=u.useState(null),[s,N]=u.useState(null),[x,f]=u.useState(!1),[ue,ee]=u.useState(null),[ie,B]=u.useState(!1),[w,p]=u.useState(!1),g=t=>{const n=[];return t?((!t.name||String(t.name).trim().length<2)&&n.push("Name is required"),(!t.street1||String(t.street1).trim().length<4)&&n.push("Street address is required"),(!t.city||String(t.city).trim().length<2)&&n.push("City is required"),(!t.state||!/^[A-Za-z]{2}$/.test(String(t.state).trim()))&&n.push("State must be 2-letter code"),(!t.zip||!/^[0-9]{5}(-[0-9]{4})?$/.test(String(t.zip).trim()))&&n.push("ZIP must be 5 digits (or 5+4)"),n):["Address missing"]},v=t=>g(t).length===0,c=(t,n)=>{const d={...i,[t]:n};J(d),E&&$(d),Z(g(d)),B(!1),b(null),m(null)},h=(t,n)=>{const d={...C,[t]:n};$(d),p(v(d))},j=t=>{if(t&&t.length>0){m(t[0]),M(!0),b(t);try{_({type:"SET_SHIPPING_COST",cost:Number(t[0].amount),rate:t[0]})}catch{}}},F=t=>{N(t),t&&t.rates&&t.rates.length>0&&j(t.rates)};u.useEffect(()=>{if(!y&&r&&r.shipping){const t=r.shipping.rateId||r.shipping.rate_id||r.shipping.rateId;if(o&&Array.isArray(o)){const n=o.find(d=>d.object_id===t||d.raw&&d.raw.id===t);if(n){m(n),M(!0);return}}m({object_id:t||r.shipping&&r.shipping.rateId||null,amount:r.shipping.cost,provider:r.shipping.label}),M(!0)}},[r.shipping,o]),u.useEffect(()=>{var t,n;if(o&&Array.isArray(o)&&o.length>0){const l=o.slice().sort((a,S)=>Number(a.amount||0)-Number(S.amount||0))[0];if(!y||y.object_id!==l.object_id){m(l),M(!0);try{_({type:"SET_SHIPPING_COST",cost:Number(l.amount),shipping:{cost:Number(l.amount),label:`${l.provider} ${((t=l.servicelevel)==null?void 0:t.name)||((n=l.servicelevel)==null?void 0:n.token)||""}`,rateId:l.object_id}})}catch{}}}},[o]),u.useEffect(()=>{const t=r.items.reduce((l,a)=>l+(a.product.weight||0)*a.quantity,0);if(!ie)return;if(t<=100){console.debug("Skipping Estes quote: total weight <= 100 lbs"),B(!1);return}if(!v(i)){console.debug("Skipping Estes quote: shipping address incomplete or invalid",i),B(!1);return}const n={checkout:{destination:{addressLine1:i.street1,city:i.city,stateProvince:i.state,postalCode:i.zip,country:i.country||"US",contactName:i.name,phone:i.phone},items:r.items.map(l=>({name:l.product.title||l.product.name||"item",weight:l.product.weight||0,quantity:l.quantity}))}};let d=!1;return(async()=>{try{ee(null),f(!0),console.log("Estes checkoutPayload:",n);const l=await fetch("/.netlify/functions/estes-quote",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),a=await l.json().catch(()=>({}));if(d)return;if(console.log("Estes response:",a),N(a),f(!1),B(!1),!l.ok){ee(a&&(a.error||a.estesResponse)?a.error||JSON.stringify(a.estesResponse):"Estes quote failed"),N(a&&a.estesResponse?a.estesResponse:a);return}const S={object_id:a.quoteNumber||`estes-${Date.now()}`,provider:a.carrier||"Estes",servicelevel:{name:"Freight (Estes)"},amount:Number(a.total||0),estimated_days:a.transitDays||void 0,raw:a.breakdown||null};b([S]),m(S);try{_({type:"SET_SHIPPING_COST",cost:Number(S.amount),shipping:{cost:Number(S.amount),label:`${S.provider} ${S.servicelevel.name}`,rateId:S.object_id}})}catch{}}catch(l){if(d)return;f(!1),ee(l&&l.message?l.message:String(l))}})(),()=>{d=!0}},[r.items,i.street1,i.city,i.state,i.zip,ie]);const pe=()=>{const t=g(i),n=[];if(t.length&&n.push(...t),y||n.push("Please select a shipping rate"),n.length){alert(`Cannot continue:
`+n.map(d=>`- ${d}`).join(`
`));return}k(!1),I(!0)},he=t=>{Q(t),t&&($(i),p(v(i)),i.email&&q(i.email))},me=()=>{if(!v(C))return alert("Please complete billing address");I(!1),ne(!0)};return e.jsxs("div",{style:{padding:24,maxWidth:840,margin:"0 auto"},children:[e.jsx("h2",{children:"Checkout"}),e.jsx(re,{title:"Shipping Information",open:V,onToggle:k,children:e.jsxs("div",{className:"form-row",children:[e.jsx("input",{className:"form-input",placeholder:"Full name",value:i.name,onChange:t=>c("name",t.target.value)}),e.jsx("input",{className:"form-input",placeholder:"Street address",value:i.street1,onChange:t=>c("street1",t.target.value)}),e.jsx("input",{className:"form-input",placeholder:"City",value:i.city,onChange:t=>c("city",t.target.value)}),e.jsxs("div",{className:"form-row--inline",style:{margin:"0 8px"},children:[e.jsxs("select",{className:"form-input form-col-state",value:i.state,onChange:t=>c("state",t.target.value),children:[e.jsx("option",{value:"",children:"State"}),e.jsx("option",{value:"AL",children:"AL"}),e.jsx("option",{value:"AK",children:"AK"}),e.jsx("option",{value:"AZ",children:"AZ"}),e.jsx("option",{value:"AR",children:"AR"}),e.jsx("option",{value:"CA",children:"CA"}),e.jsx("option",{value:"CO",children:"CO"}),e.jsx("option",{value:"CT",children:"CT"}),e.jsx("option",{value:"DE",children:"DE"}),e.jsx("option",{value:"FL",children:"FL"}),e.jsx("option",{value:"GA",children:"GA"}),e.jsx("option",{value:"HI",children:"HI"}),e.jsx("option",{value:"ID",children:"ID"}),e.jsx("option",{value:"IL",children:"IL"}),e.jsx("option",{value:"IN",children:"IN"}),e.jsx("option",{value:"IA",children:"IA"}),e.jsx("option",{value:"KS",children:"KS"}),e.jsx("option",{value:"KY",children:"KY"}),e.jsx("option",{value:"LA",children:"LA"}),e.jsx("option",{value:"ME",children:"ME"}),e.jsx("option",{value:"MD",children:"MD"}),e.jsx("option",{value:"MA",children:"MA"}),e.jsx("option",{value:"MI",children:"MI"}),e.jsx("option",{value:"MN",children:"MN"}),e.jsx("option",{value:"MS",children:"MS"}),e.jsx("option",{value:"MO",children:"MO"}),e.jsx("option",{value:"MT",children:"MT"}),e.jsx("option",{value:"NE",children:"NE"}),e.jsx("option",{value:"NV",children:"NV"}),e.jsx("option",{value:"NH",children:"NH"}),e.jsx("option",{value:"NJ",children:"NJ"}),e.jsx("option",{value:"NM",children:"NM"}),e.jsx("option",{value:"NY",children:"NY"}),e.jsx("option",{value:"NC",children:"NC"}),e.jsx("option",{value:"ND",children:"ND"}),e.jsx("option",{value:"OH",children:"OH"}),e.jsx("option",{value:"OK",children:"OK"}),e.jsx("option",{value:"OR",children:"OR"}),e.jsx("option",{value:"PA",children:"PA"}),e.jsx("option",{value:"RI",children:"RI"}),e.jsx("option",{value:"SC",children:"SC"}),e.jsx("option",{value:"SD",children:"SD"}),e.jsx("option",{value:"TN",children:"TN"}),e.jsx("option",{value:"TX",children:"TX"}),e.jsx("option",{value:"UT",children:"UT"}),e.jsx("option",{value:"VT",children:"VT"}),e.jsx("option",{value:"VA",children:"VA"}),e.jsx("option",{value:"WA",children:"WA"}),e.jsx("option",{value:"WV",children:"WV"}),e.jsx("option",{value:"WI",children:"WI"}),e.jsx("option",{value:"WY",children:"WY"}),e.jsx("option",{value:"DC",children:"DC"})]}),e.jsx("input",{className:"form-input form-col-zip",placeholder:"ZIP",value:i.zip,onChange:t=>c("zip",t.target.value)})]}),e.jsx("input",{className:"form-input",placeholder:"Phone (optional but recommended)",value:i.phone,onChange:t=>c("phone",t.target.value)}),e.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,alignItems:"center",marginLeft:8},children:[(()=>{const t={name:"Agex Parts",street1:"1128 East Dunkerton Road",city:"Cedar Falls",state:"IA",zip:"50613",country:"US",phone:"3198309777"};return e.jsx(xe,{compact:!0,inlineResults:!1,disabled:O.length>0,cart:r,toAddress:i,fromAddress:t,onRates:j,onResponse:F,onSelect:n=>{m(n),M(!0),b(d=>d||[n])},showResults:!0,onCalculateClick:()=>B(!0)})})(),e.jsx("div",{children:e.jsx("button",{onClick:pe,className:"btn primary",disabled:!v(i),style:{padding:"0.45rem 1rem",fontSize:"0.95rem"},children:"Continue to Billing"})})]}),O&&O.length>0&&e.jsx("div",{style:{color:"#b00020",marginTop:10,marginLeft:8},children:O.map((t,n)=>e.jsxs("div",{style:{fontSize:"0.95rem"},children:["• ",t]},n))}),o&&Array.isArray(o)&&e.jsxs("div",{style:{marginTop:12},children:[e.jsx("b",{children:"Shipping Rates (select)"}),e.jsx("ul",{style:{margin:0,padding:0,listStyle:"none"},children:o.slice().sort((t,n)=>Number(t.amount||0)-Number(n.amount||0)).map((t,n,d)=>{var l,a,S;return e.jsxs("li",{style:{margin:"6px 0",display:"flex",alignItems:"center",gap:8},children:[e.jsx("input",{type:"radio",name:"checkoutShippingRate",value:t.object_id,checked:y&&(y.object_id===t.object_id||((l=y.raw)==null?void 0:l.id)===t.object_id)||!y&&d[0]&&d[0].object_id===t.object_id,onChange:()=>{var T,D;m(t),M(!0);try{_({type:"SET_SHIPPING_COST",cost:Number(t.amount),shipping:{cost:Number(t.amount),label:`${t.provider} ${((T=t.servicelevel)==null?void 0:T.name)||((D=t.servicelevel)==null?void 0:D.token)||""}`,rateId:t.object_id}})}catch{}}}),e.jsxs("div",{style:{flex:1},children:[e.jsxs("div",{style:{fontWeight:700},children:[t.provider," ",((a=t.servicelevel)==null?void 0:a.name)||((S=t.servicelevel)==null?void 0:S.token)]}),e.jsxs("div",{style:{color:"#555"},children:[t.estimated_days||"?"," days"]})]}),e.jsxs("div",{style:{minWidth:90,textAlign:"right",fontWeight:700},children:["$",t.amount]})]},t.object_id)})})]})]})}),e.jsx(re,{title:"Billing Details",open:P,onToggle:I,disabled:!v(i)||!G,children:e.jsxs("div",{style:{display:"grid",gap:8},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("input",{type:"checkbox",checked:E,onChange:t=>he(t.target.checked)})," Use shipping details as billing"]}),!E&&e.jsxs(e.Fragment,{children:[e.jsx("input",{className:"form-input",placeholder:"Full name",value:C.name,onChange:t=>h("name",t.target.value)}),e.jsx("input",{className:"form-input",placeholder:"Street address",value:C.street1,onChange:t=>h("street1",t.target.value)}),e.jsx("input",{className:"form-input",placeholder:"City",value:C.city,onChange:t=>h("city",t.target.value)}),e.jsx("input",{className:"form-input",placeholder:"State",value:C.state,onChange:t=>h("state",t.target.value)}),e.jsx("input",{className:"form-input",placeholder:"ZIP",value:C.zip,onChange:t=>h("zip",t.target.value)}),e.jsx("input",{className:"form-input",placeholder:"Phone",value:C.phone,onChange:t=>h("phone",t.target.value)}),e.jsx("input",{className:"form-input",placeholder:"Email",value:W,onChange:t=>q(t.target.value)})]}),e.jsx("div",{style:{marginTop:8},children:e.jsx("button",{onClick:me,className:"btn primary",children:"Continue to Payment"})})]})}),e.jsx(re,{title:"Payment",open:le,onToggle:ne,disabled:!w&&!E,children:e.jsxs("div",{style:{display:"grid",gap:12},children:[(()=>{const t=r.items.reduce((S,T)=>{const D=Number(T.product.price),z=Number(T.product.discount_perc)||0,H=T.product.discount_end_date?new Date(T.product.discount_end_date):null,te=new Date,A=z>0&&(!H||te<=H)&&!isNaN(D)?D*(1-z):D;return S+A*T.quantity},0),n=r.shipping?Number(r.shipping.cost||0):0,d=Number(ce(i==null?void 0:i.state)),l=+(t*d).toFixed(2),a=+(t+l+n).toFixed(2);return e.jsxs("div",{style:{background:"#fff",padding:12,borderRadius:8},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:6},children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("strong",{children:["$",t.toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:6},children:[e.jsxs("span",{children:["Tax (",(d*100).toFixed(2),"%)"]}),e.jsxs("strong",{children:["$",l.toFixed(2)]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:6},children:[e.jsx("span",{children:"Shipping"}),e.jsxs("strong",{children:["$",n.toFixed(2)]})]}),e.jsx("hr",{style:{border:"none",borderTop:"1px solid #eee",margin:"8px 0"}}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"1.1rem"},children:[e.jsx("span",{children:"Total"}),e.jsxs("strong",{children:["$",a.toFixed(2)]})]})]})})(),e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:8,color:"#333"},children:"Select a secure payment method below — you will be redirected to the provider to enter payment details."}),e.jsxs("select",{value:U,onChange:t=>X(t.target.value),className:"form-input",style:{width:240},children:[e.jsx("option",{value:"stripe",children:"Credit / Debit Card (Stripe)"}),e.jsx("option",{value:"ach",children:"Bank Transfer (ACH)"})]})]}),e.jsx("div",{style:{marginTop:12},children:e.jsx("button",{className:"btn brand",onClick:async()=>{var te,oe;if(!U)return alert("Please select a payment method");let t=null;try{window.turnstile&&typeof window.turnstile.execute=="function"&&(t=await new Promise((A,L)=>{const R=document.createElement("div");R.style.position="absolute",R.style.left="-9999px",document.body.appendChild(R);const K=document.createElement("div");R.appendChild(K);const se=window.turnstile.render(K,{sitekey:"",callback:Y=>{try{document.body.removeChild(R)}catch{}A(Y)}});setTimeout(()=>{try{window.turnstile.execute(se)}catch(Y){try{document.body.removeChild(R)}catch{}L(Y)}},50)}))}catch(A){console.warn("Turnstile error",A)}const n=r.items.reduce((A,L)=>{const R=Number(L.product.price),K=Number(L.product.discount_perc)||0,se=L.product.discount_end_date?new Date(L.product.discount_end_date):null,Y=new Date,ge=K>0&&(!se||Y<=se)&&!isNaN(R)?R*(1-K):R;return A+ge*L.quantity},0),d=r&&r.shipping?Number(r.shipping.cost||0):r&&r.shipping_cost?Number(r.shipping_cost):0,l=Number(ce(i==null?void 0:i.state)),a=+(n*l).toFixed(2),S=+(n+a+d).toFixed(2),T=`Review order:
Subtotal: $${n.toFixed(2)}
Tax: $${a.toFixed(2)}
Shipping: $${d.toFixed(2)}

Total: $${S.toFixed(2)}

Continue to Stripe Checkout?`;if(!window.confirm(T))return;const D={cart:r.items.map(A=>({product:A.product,quantity:A.quantity})),customer_name:C.name||i.name,customer_email:W||"",shippingCost:d,taxCost:a,captchaToken:t,shipping:i,billing:C,selectedRate:y?{id:y.object_id||((te=y.raw)==null?void 0:te.id)||y.rate_id||null,provider:y.provider||null,service:((oe=y.servicelevel)==null?void 0:oe.name)||y.service||null,amount:y.amount||null}:null},z=await fetch("/.netlify/functions/create-checkout-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(D)});if(!z.ok){const A=await z.json().catch(()=>({error:"Unknown error"}));return alert(A.error||"Checkout failed")}const H=await z.json();H&&H.url&&(window.location=H.url)},children:"Place Order"})})]})})]})}export{je as default};
