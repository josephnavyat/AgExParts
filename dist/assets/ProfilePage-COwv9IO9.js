import{r as o,R as oe,j as e,L as b}from"./index-DQiy-OUL.js";import{c as ne,B as m,P as se,T as l,a as i}from"./Paper-BO-NLJZ9.js";import{T as le,C as ie}from"./Container-ErREttOU.js";import{T as n}from"./TextField-BQPZ1r3g.js";function pe(){const[r,h]=o.useState(()=>{const t=localStorage.getItem("jwt");if(!t)return null;try{return JSON.parse(atob(t.split(".")[1]))}catch{return null}}),[x,d]=o.useState(""),[p,g]=o.useState({first_name:(r==null?void 0:r.first_name)||"",last_name:(r==null?void 0:r.last_name)||"",email:(r==null?void 0:r.email)||"",address:(r==null?void 0:r.address)||"",phone:(r==null?void 0:r.phone)||""}),[u,L]=o.useState("login"),[v,J]=o.useState(""),[W,$]=o.useState(""),[S,z]=o.useState(""),[N,I]=o.useState(""),[_,H]=o.useState(""),[B,X]=o.useState(""),[F,Y]=o.useState(""),[O,G]=o.useState(""),[D,w]=o.useState(!1),[K,j]=o.useState(!1),[R,A]=o.useState(""),Q=async t=>{if(t.preventDefault(),w(!0),d(""),A(""),u==="login"&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)){A("Please enter a valid email address"),w(!1);return}try{const c=await fetch(u==="login"?"/.netlify/functions/login-user":"/.netlify/functions/register-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u==="login"?{email:v,password:S}:{username:W,password:S,first_name:N,last_name:_,email:B,address:F,phone:O})}),y=await c.json();if(c.ok)if(u==="login"){d("Login successful!"),localStorage.setItem("jwt",y.token);try{const re=JSON.parse(atob(y.token.split(".")[1]));h(re)}catch{h({email:v})}}else d("Registration successful! You can now log in."),L("login");else d(y.error||"Error occurred")}catch{d("Network error")}w(!1)},V=()=>{localStorage.removeItem("jwt"),h(null),d("Logged out successfully."),j(!1)},Z=ne({palette:{mode:"light",primary:{main:"#19a974"},background:{default:"#f7f7f7",paper:"#ffffff"},text:{primary:"#222",secondary:"#555"}}}),[C,E]=o.useState(null),[P,f]=o.useState(""),[q,T]=o.useState(null),[k,M]=o.useState(0),[ee,te]=o.useState(null),[U,ae]=o.useState(null);return oe.useEffect(()=>{async function t(){try{const a=localStorage.getItem("jwt");if(!a)return;const s=await fetch("/.netlify/functions/get-user",{headers:{Authorization:`Bearer ${a}`}});if(!s.ok)return;const c=await s.json();c&&c.user&&(te(!!c.user.tax_exempt_status),ae(c.user.tax_exempt_exp_date||null),h(y=>({...y||{},...c.user})))}catch(a){console.error("Failed to fetch profile",a)}}t()},[]),e.jsx(le,{theme:Z,children:e.jsx(ie,{maxWidth:"sm",children:e.jsx(m,{sx:{mt:6},children:e.jsx(se,{elevation:6,sx:{p:4,borderRadius:3,bgcolor:"background.paper"},children:r?e.jsxs(m,{children:[e.jsxs(l,{variant:"h4",align:"center",gutterBottom:!0,color:"text.primary",children:["Welcome, ",r.first_name," ",r.last_name,"!"]}),e.jsxs(m,{sx:{display:"flex",justifyContent:"center",mb:3,gap:2},children:[e.jsx(i,{variant:"outlined",color:"primary",component:b,to:"#account-info",sx:{fontWeight:600},children:"Account Info"}),e.jsx(i,{variant:"outlined",color:"primary",component:b,to:"#tax-exemption",sx:{fontWeight:600},children:"Tax Exemption"}),r.user_type==="admin"&&e.jsx(i,{variant:"outlined",color:"secondary",component:b,to:"/orders",sx:{fontWeight:600},children:"Order Dashboard"})]}),e.jsxs(m,{id:"account-info",sx:{mb:3,p:2,borderRadius:2,bgcolor:"background.default",color:"text.primary"},children:[e.jsxs(l,{variant:"body1",children:[e.jsx("strong",{children:"Username:"})," ",r.username]}),e.jsxs(l,{variant:"body1",children:[e.jsx("strong",{children:"Email:"})," ",r.email||"—"]}),e.jsxs(l,{variant:"body1",children:[e.jsx("strong",{children:"Address:"})," ",r.address||"—"]}),e.jsxs(l,{variant:"body1",children:[e.jsx("strong",{children:"Phone:"})," ",r.phone||"—"]})]}),e.jsxs(m,{id:"tax-exemption",sx:{mb:3,p:2,borderRadius:2,bgcolor:"background.default",color:"text.primary"},children:[e.jsx(l,{variant:"h6",sx:{mb:1},children:"Tax Exemption"}),e.jsx(n,{label:"Tax Exemption",variant:"filled",value:ee?"Tax Exempt":"Not Tax Exempt",InputProps:{readOnly:!0},fullWidth:!0,sx:{mb:2}}),e.jsx(n,{label:"Tax Exemption Expiration",variant:"filled",value:U?new Date(U).toLocaleDateString():"—",InputProps:{readOnly:!0},fullWidth:!0,sx:{mb:2}}),e.jsx(l,{variant:"body2",sx:{mb:1},children:"Upload your tax exemption document (PDF or image). Our team will review and update your status."}),e.jsx("input",{id:"tax-file",type:"file",accept:"application/pdf,image/*",onChange:t=>{const a=t.target.files&&t.target.files[0];if(E(a),a&&a.type&&a.type.startsWith("image/")){const s=URL.createObjectURL(a);T(s)}else T(null)},style:{marginBottom:8}}),q&&e.jsx("img",{src:q,alt:"preview",style:{maxWidth:"100%",marginBottom:8}}),e.jsxs(m,{sx:{display:"flex",gap:1,mb:1},children:[e.jsx(i,{variant:"contained",color:"primary",disabled:!C,onClick:()=>{if(!C)return;f(""),M(0);const t=new FormData;t.append("file",C),t.append("username",r.username||"");const a=new XMLHttpRequest;a.open("POST","/.netlify/functions/upload-tax-exempt"),a.upload.onprogress=s=>{s.lengthComputable&&M(Math.round(s.loaded/s.total*100))},a.onload=()=>{try{const s=JSON.parse(a.responseText||"{}");if(a.status>=200&&a.status<300){f("Upload successful. We will review and update your tax exemption status."),E(null),T(null);const c=document.getElementById("tax-file");c&&(c.value="")}else f(s.error||"Upload failed")}catch{f("Upload returned unexpected response")}},a.onerror=()=>f("Network error during upload"),a.send(t)},children:"Upload"}),e.jsx(i,{variant:"outlined",color:"secondary",onClick:()=>{E(null);const t=document.getElementById("tax-file");t&&(t.value=""),f("")},children:"Cancel"})]}),k>0&&k<100&&e.jsxs(l,{variant:"body2",children:["Uploading: ",k,"%"]}),P&&e.jsx(l,{variant:"body2",color:P.toLowerCase().includes("success")?"primary":"error",children:P})]}),K?e.jsxs(m,{component:"form",onSubmit:async t=>{t.preventDefault(),d("");try{const a=await fetch("/.netlify/functions/update-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("jwt")}`},body:JSON.stringify(p)}),s=await a.json();a.ok?(h({...r,...p}),j(!1),d("Profile updated successfully.")):d(s.error||"Error updating profile.")}catch{d("Network error updating profile.")}},sx:{display:"flex",flexDirection:"column",gap:2,mb:2},children:[e.jsx(n,{label:"First Name",variant:"filled",value:p.first_name,onChange:t=>g(a=>({...a,first_name:t.target.value})),required:!0,color:"primary"}),e.jsx(n,{label:"Last Name",variant:"filled",value:p.last_name,onChange:t=>g(a=>({...a,last_name:t.target.value})),required:!0,color:"primary"}),e.jsx(n,{label:"Email",variant:"filled",value:p.email,onChange:t=>g(a=>({...a,email:t.target.value})),type:"email",color:"primary"}),e.jsx(n,{label:"Address",variant:"filled",value:p.address,onChange:t=>g(a=>({...a,address:t.target.value})),color:"primary"}),e.jsx(n,{label:"Phone Number",variant:"filled",value:p.phone,onChange:t=>g(a=>({...a,phone:t.target.value})),type:"tel",color:"primary"}),e.jsx(i,{type:"submit",variant:"contained",color:"primary",sx:{fontWeight:600},children:"Save Changes"}),e.jsx(i,{type:"button",variant:"outlined",color:"secondary",sx:{mt:1},onClick:()=>j(!1),children:"Cancel"})]}):e.jsx(i,{fullWidth:!0,variant:"contained",color:"primary",sx:{mb:2,fontWeight:600},onClick:()=>j(!0),children:"Edit Profile"}),e.jsx(i,{fullWidth:!0,variant:"contained",color:"error",sx:{fontWeight:600},onClick:V,children:"Logout"}),x&&e.jsx(l,{sx:{mt:2},align:"center",color:x.includes("success")?"primary":"error",fontWeight:600,children:x})]}):e.jsxs(m,{children:[e.jsx(l,{variant:"h4",align:"center",gutterBottom:!0,color:"text.primary",children:u==="login"?"Login":"Create Account"}),e.jsxs(m,{component:"form",onSubmit:Q,sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(n,{label:"Email",variant:"filled",value:v,onChange:t=>J(t.target.value),required:!0,type:"email",color:"primary",error:!!R,helperText:R}),e.jsx(n,{label:"Password",variant:"filled",type:"password",value:S,onChange:t=>z(t.target.value),required:!0,color:"primary"}),u==="register"&&e.jsxs(e.Fragment,{children:[e.jsx(n,{label:"Username",variant:"filled",value:W,onChange:t=>$(t.target.value),required:!0,color:"primary"}),e.jsx(n,{label:"First Name",variant:"filled",value:N,onChange:t=>I(t.target.value),required:!0,color:"primary"}),e.jsx(n,{label:"Last Name",variant:"filled",value:_,onChange:t=>H(t.target.value),required:!0,color:"primary"}),e.jsx(n,{label:"Email",variant:"filled",value:B,onChange:t=>X(t.target.value),type:"email",color:"primary"}),e.jsx(n,{label:"Address",variant:"filled",value:F,onChange:t=>Y(t.target.value),color:"primary"}),e.jsx(n,{label:"Phone Number",variant:"filled",value:O,onChange:t=>G(t.target.value),type:"tel",color:"primary"})]}),e.jsx(i,{type:"submit",disabled:D,variant:"contained",color:"primary",sx:{fontWeight:600},children:D?"Please wait...":u==="login"?"Login":"Register"})]}),e.jsxs(m,{sx:{mt:2,textAlign:"center",display:"flex",flexDirection:"column",gap:1},children:[e.jsx(i,{variant:"text",color:"primary",onClick:()=>L(u==="login"?"register":"login"),sx:{fontWeight:600},children:u==="login"?"Create an account":"Already have an account? Login"}),u==="login"&&e.jsx(i,{variant:"text",color:"secondary",sx:{fontWeight:600},component:b,to:"/recover-password",children:"Forgot Password?"})]}),x&&e.jsx(l,{sx:{mt:2},align:"center",color:x.includes("success")?"primary":"error",fontWeight:600,children:x})]})})})})})}export{pe as default};
